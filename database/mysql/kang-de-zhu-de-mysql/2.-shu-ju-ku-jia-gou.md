# 主从架构

Master\(1\) =&gt; Slave\(15\)

没有主从复制的高可用组件，如果主服务器出现了故障，很难自动进行主从切换，只能由DBA在众多的从服务器中选出一台数据最新的，提升作为主服务器，然后其他从与新主服务器进行同步。这种操作很耗时，对主服务器的网卡有要求。

主服务器性能 QPS 峰值可达350000次，TPS 每秒也超过50000-100000次。已经所示具有不错的吞吐量。

## 监控指标

并发量、CPU使用率\(idle\), 磁盘IO读写（出现读写峰值竟然是因为数据备份的远程同步任务引起的，所以在大促活动时，最好停止掉这些计划任务）

影响服务器性能的因素： SQL的查询速度、服务器硬件、磁盘IO、网卡流量

大多数服务器性能问题都是由于 sql语句的慢查询引起的，可以通过优化SQL语句提高执行效率。

**大量的 并发 和 超高的CPU使用率 带来的风险：**

1. 数据库连接被沾满（max\_connections默认值100）
2. CPU资源耗尽出现宕机

**网卡流量的控制**

1. 减少从服务器的数量
2. 进行分级缓存，放置前端数据突然失效，产生的大量查询
3. 避免使用 select \* 进行查询
4. 分离业务网络和服务器网络

**大表产生的影响** 1. 记录行数巨大，单表超过千万航 2. 表数据文件巨大，超过10G

往往意味着慢查询的产生，在上亿条数据的表中查询区分度很低的分类就会产生大量的磁盘IO，降低数据库的性能。

1. 对DDL（数据定义语言Data Definition Language）操作的影响（表结构的修改），建立索引需要很长的时间，=5.5版本不会锁表会引起主从延迟
2. 解决方法：分库分表（面临的问题：分表主键的选择、分表后跨分区数据的查询和统计）
3. 另一种方法：大表的历史数据归档（面临问题：对党时间点的选择、如何进行归档操作-从当前表删除归档的数据）

**大事务的影响** 1. 事务的原子性 \(atomicity\) 从理财账户转账到存款账户2000这个操作的事务构成：检测理财账户余额是否高于2000元-从理财账户余额中减去2000-在活期存款账户增加2000元 （要么所有操作全部完成、要么失败全部回滚）

1. 事务的一致性（consistency）
2. 事务的隔离性（isolation） 要求一个事务对数据库中数据的修改，在未提交完成前对于其他事务是不可见的
3. 未提交读（read uncommitted）脏读 读到的称为脏数据
4. 已提交读（read committed）  - 不可重复读（除mysql外，其他数据库默认事务）
5. 可重复读（repeatable read） 当前事务读不到其他事务提交的数据
6. 可串行化（serializable） 

   以上顺序 隔离性由低到高，并发性由高到低

什么是大事务？ 定义：运行时间比较长，操作的数据比较多的事务 风险：锁定太多的数据，造成大量的阻塞和锁超时，回滚时需要的时间比较长，容易造成主从延迟

如何处理大事务？ 1. 避免一次处理太多的数据 2. 移除不必要在事务中的select操作

```text
mysql> CREATE TABLE `trans` (
    -> id INT PRIMARY KEY AUTO_INCREMENT
    -> ) ENGINE=InnoDB DEFAULT CHARSET=utf8;

mysql> desc trans;
+-------+---------+------+-----+---------+----------------+
| Field | Type    | Null | Key | Default | Extra          |
+-------+---------+------+-----+---------+----------------+
| id    | int(11) | NO   | PRI | NULL    | auto_increment |
+-------+---------+------+-----+---------+----------------+
1 row in set (0.01 sec)

INSERT 插入多条数据
INSERT INTO table_name  (field1, field2,...fieldN)  VALUES  (valueA1,valueA2,...valueAN),(valueB1,valueB2,...valueBN),(valueC1,valueC2,...valueCN);

mysql> INSERT INTO `trans` VALUES (1),(3),(5),(7),(9),(10);
Query OK, 6 rows affected (0.01 sec)
Records: 6  Duplicates: 0  Warnings: 0

mysql> select * from trans;
+----+
| id |
+----+
|  1 |
|  3 |
|  5 |
|  7 |
|  9 |
| 10 |
+----+
6 rows in set (0.01 sec)

查看事务的隔离级别：
mysql> show variables like '%iso%';
+-----------------------+-----------------+
| Variable_name         | Value           |
+-----------------------+-----------------+
| transaction_isolation | REPEATABLE-READ |
| tx_isolation          | REPEATABLE-READ |
+-----------------------+-----------------+
2 rows in set (0.04 sec)
```

